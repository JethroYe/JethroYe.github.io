I"ÃI<h2 id="å¤§æ¦‚è¯´è¯´å†…å­˜">å¤§æ¦‚è¯´è¯´å†…å­˜</h2>
<p>å†…å­˜ä¸€å°è®¡ç®—æœºä¸­æ‰€æœ‰ç¨‹åºå…±äº«çš„é‡è¦çš„ç³»ç»Ÿèµ„æºã€‚ç¨‹åºå°†è‡ªå·±çš„ä»£ç å’Œæ•°æ®è£…è½½è¿›å†…å­˜ä¸­æ‰èƒ½è¿è¡Œèµ·æ¥ã€‚ä¸ºäº†ä½¿ç”¨è¿ç»­çš„åœ°å€ç©ºé—´ï¼Œä»¥åŠè¿›ç¨‹/å†…æ ¸ä¹‹é—´çš„å†…å­˜éš”ç¦»ä¸å…±äº«ç­‰ç­‰è¯¸å¤šä¼˜ç‚¹ï¼Œç°åœ¨å‡ ä¹æ‰€æœ‰çš„æ“ä½œç³»ç»Ÿéƒ½ä¼šä½¿ç”¨<strong>è™šæ‹Ÿå†…å­˜</strong>ã€‚å½“ç¨‹åºä»£ç è®¿é—®åˆ°é€»è¾‘åœ°å€æ—¶ï¼Œ<strong>MMU</strong>(memory management unit)é€šè¿‡é¡µè¡¨å°†é€»è¾‘åœ°å€è½¬æ¢ä¸ºå®é™…çš„ç¡¬ä»¶åœ°å€ã€‚å¦‚æœåº”ç”¨ç¨‹åºè®¿é—®ä¸€æ®µå½“å‰ä¸åœ¨ç‰©ç† RAM  ä¸­çš„å†…å­˜é¡µä¸Šçš„åœ°å€ï¼Œå°±ä¼šå‘ç”Ÿ <strong>page fault</strong>ã€‚æ­¤æ—¶è™šæ‹Ÿå†…å­˜ç³»ç»Ÿä¼šè°ƒç”¨ä¸€ä¸ªç‰¹æ®Šçš„é¡µé¢é”™è¯¯å¤„ç†ç¨‹åºæ¥ç«‹å³å“åº”é”™è¯¯ã€‚é¡µé¢é”™è¯¯å¤„ç†ç¨‹åºåœæ­¢å½“å‰æ­£åœ¨æ‰§è¡Œçš„ä»£ç ï¼Œå¯»æ‰¾ä¸€ä¸ªç©ºé—²çš„ç‰©ç†å†…å­˜é¡µé¢ï¼Œä»ç£ç›˜åŠ è½½åŒ…å«æ‰€éœ€æ•°æ®çš„é¡µé¢ï¼Œæ›´æ–°é¡µè¡¨ï¼Œç„¶åå°†æ§åˆ¶æƒè¿”å›ç»™ç¨‹åºä»£ç ã€‚è¿™ä¸ªè¿‡ç¨‹è¢«ç§°ä¸º<strong>paging</strong>ã€‚è¯·æ³¨æ„è¿™ä¸ªè¿‡ç¨‹æ˜¯æœ‰äº›è€—æ—¶çš„ã€‚é€šè¿‡ä¼˜åŒ–æ‰è¿™äº›è€—æ—¶ï¼Œå¯ä»¥ä¸€å®šç¨‹åº¦æé«˜Appçš„å¯åŠ¨é€Ÿåº¦ã€‚ è¿™å°±æ˜¯ <a href="https://www.infoq.cn/article/b8m2hrjwbryr7tasurhq">æŠ–éŸ³äºŒè¿›åˆ¶é‡æ’æé«˜å¯åŠ¨é€Ÿåº¦</a> çš„åŸç†ã€‚</p>

<p>å¦‚æœç‰©ç†å†…å­˜ç”¨å®Œäº†ï¼Œå¤„ç†ç¨‹åºå¿…é¡»é‡Šæ”¾æ‰ä¸€äº›ç°æœ‰çš„é¡µé¢ä¸ºæ–°é¡µé¢è…¾å‡ºç©ºé—´ã€‚é‡Šæ”¾é¡µé¢çš„æ–¹å¼åœ¨ä¸åŒç³»ç»Ÿä¸Šä¸ä¸€æ ·:Mac OS ä¸Šä¼šé€šè¿‡ page out â€“ page in çš„æ–¹å¼åœ¨å†…å­˜å’Œç¡¬ç›˜ä¸­ä¼ é€’æ•°æ®ï¼Œåœ¨iOS ä¸­ï¼Œpage outåˆ°ç£ç›˜çš„éƒ¨åˆ†è¢«å†…å­˜æ•°æ®å‹ç¼©æ–¹æ³•å–ä»£ã€‚ä¸è¿‡ä»ç„¶ä¼šæœ‰åªè¯»æ•°æ®è¢«å­˜æ”¾åœ¨ç£ç›˜ä¸­ã€‚</p>

<p>Mac OS å’Œ iOS éƒ½æä¾›äº†å¤šç§åˆ†é…æ–¹å¼ã€‚ä½†æœ€ç»ˆæ‰€æœ‰å†…å­˜åˆ†é…æœ€ç»ˆéƒ½ä½¿ç”¨ libmalloc åº“æ¥åˆ›å»ºå†…å­˜ã€‚ç”šè‡³ Cocoa å¯¹è±¡æœ€ç»ˆä¹Ÿæ˜¯ä½¿ç”¨ <strong>libmalloc</strong> åº“åˆ†é…çš„ã€‚ä½¿ç”¨è¿™ä¸ªå•ä¸€åº“çš„ä¸»è¦å¥½å¤„æ˜¯å¯ä»¥ä½¿æ€§èƒ½å·¥å…·å¯ä»¥æŠ¥å‘Šåº”ç”¨ç¨‹åºä¸­çš„æ‰€æœ‰å†…å­˜åˆ†é…ã€‚</p>

<p>æœ¬æ–‡å°†ä¸»è¦ä»‹ç»<strong>lbmallocçš„ç»“æ„</strong>å’Œ<strong>ç®€å•çš„å†…å­˜ç”³è¯·æµç¨‹</strong>ã€‚</p>

<h2 id="libmalloc-çš„ç»“æ„">libmalloc çš„ç»“æ„</h2>
<p>é¦–å…ˆï¼Œä»å°åˆ°å¤§è®°ä½å‡ ä¸ªå…³é”®åè¯:<strong>blockï¼Œregionï¼Œmagazineï¼Œrackï¼Œzone</strong></p>

<h5 id="block">block</h5>
<p>block ä¹Ÿå¯ä»¥ç§°ä¸º quantumã€‚æ˜¯libmalloc æ‰€åˆ†é…å†…å­˜çš„æœ€å°å•ä½ã€‚ä¸åŒåˆ†é…æƒ…å†µä¸‹blockçš„å¤§å°ä¸åŒï¼Œä½†æ˜¯å›ºå®šçš„ã€‚æ¯ä¸ªblockçš„å¤§å°æ˜¯0x10byte(æˆ–è€…0x200byte)ã€‚å½“è¯·æ±‚çš„sizeå°äº0x10 æ—¶ï¼Œåˆ†é…ä¸€ä¸ªblockï¼Œä»‹äº0x10 å’Œ 0x20 ä¹‹é—´æ—¶ï¼Œåˆ†é…ä¸¤ä¸ªblockã€‚libmalloc ä¼šå°†freeè¿‡åçš„blockæ·»åŠ åˆ°free_lists ä¸­ã€‚æ³¨æ„ï¼Œä¸€ä¸ªblockçš„å¤§å°åˆšå¥½å­˜æ”¾2ä¸ªæŒ‡é’ˆï¼ˆ0x8byteï¼‰ã€‚å½“block è¢«é‡Šæ”¾åï¼Œå¯ä»¥å­˜æ”¾pre/next ä¸¤ä¸ªæŒ‡é’ˆ</p>
<h5 id="zone">zone</h5>
<p>libmalloc ä¸­ä¸»è¦çš„æ“ä½œå¯¹è±¡ã€‚å†…å­˜åˆ†é…çš„ä¸»è¦å…¥å£ï¼Œç±»å‹ä¸Šå¯ä»¥åˆ†ä¸ºscalable_zone å’Œ nano_zone ä¸¤ç±»</p>

<h5 id="rack">rack</h5>
<p>zone ä¸­åŒ…å«ç€è®¸å¤šç§ç±»çš„rackã€‚ä»¥scalable_zoneä¸ºä¾‹ï¼Œä½¿ç”¨ä¸åŒçš„rack å’Œç”³è¯·å†…å­˜çš„sizeæœ‰å…³ã€‚åœ¨ä¸åŒçš„racké‡Œï¼Œblockçš„å¤§å°æ˜¯ä¸ä¸€æ ·çš„ã€‚</p>
<blockquote>
  <p><strong>tiny_rack</strong>: size &lt; 1009byte<br />
<strong>samll_rack</strong>:1009byte ~ 32KB<br />
<strong>mediun_rack</strong>: 32KB~8MB</p>
</blockquote>

<h5 id="magazine">magazine</h5>
<p>magazineæ˜¯çœŸæ­£æ“ä½œå †å†…å­˜çš„å¯¹è±¡ã€‚rack ä¸­æœ‰magazineçš„æ•°ç»„magazinesï¼Œå…¶ä¸­magazine çš„ä¸ªæ•°æ˜¯ç”±CPU(logical CPU)çš„ä¸ªæ•°å†³å®šçš„ã€‚</p>

<p>å…¶ä¸­ï¼ŒlogicalCPU = ç‰©ç†CPUæ•°*æ¯ä¸ªç‰©ç†CPUçš„æ ¸å¿ƒæ•°</p>

<h5 id="heap-region">heap region</h5>

<p>heap region æ˜¯åˆ†é…ç»™ç”¨æˆ·çš„çš„å†…å­˜çš„çœŸæ­£åŒºåŸŸ</p>

<h2 id="ä»å¤§åˆ°å°ä»zone-åˆ°-block">ä»å¤§åˆ°å°ï¼Œä»zone åˆ° block</h2>
<h5 id="zone-1">zone</h5>
<p>åœ¨libmalloc ä¸­ zone åˆ†2ç§ç±»å‹: <strong>scalable_zone</strong> å’Œ <strong>nano_zone</strong>ã€‚åˆ†é…sizeå°äº256byteï¼Œä½¿ç”¨nano_zoneï¼Œå¦åˆ™ä½¿ç”¨scalable_zoneã€‚å…¶ä¸­ nano_zone è¿˜åŒºåˆ†ä¸ºv1ï¼Œv2ä¸¤ä¸ªç‰ˆæœ¬ï¼Œv2æ˜¯v1 çš„å‡çº§ç‰ˆæœ¬ã€‚å½“å¯åŠ¨æ—¶è®¾ç½®äº†v2 mode ä¸ºforce æˆ–è€… enable çš„æ˜¯æ—¶å€™ï¼Œä¼šä½¿ç”¨v2ï¼Œå¦åˆ™å…¶ä»–æƒ…å†µä¸‹ä¼šä½¿ç”¨v1 mode çš„ nano_zone</p>

<p>é™¤äº†scalable_zone å’Œ nano_zone ä¹‹å¤–ï¼Œè¿˜æœ‰ <strong>default_zone</strong> å’Œ <strong>helper_zone</strong> ä¸¤ä¸ªè¾…åŠ©çš„zoneï¼Œå…¶ä¸­default_zone æ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„zone ï¼Œè´Ÿè´£å¯»æ‰¾å¯¹åº”çš„zoneæ¥åˆ†é…å†…å­˜ï¼Œ helper_zoneæ˜¯ä¸€ä¸ªscalable_zoneï¼Œç”¨æ¥åˆ†é…å…¶ä»–çš„zoneã€‚</p>

<p><strong>malloc_zones</strong> æ˜¯libmallocçš„ä¸€ä¸ªå…¨å±€å˜é‡æŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€ä¸ªzoneæŒ‡é’ˆæ•°ç»„ï¼ŒZoneå¯¹è±¡é€šè¿‡ç³»ç»Ÿè°ƒç”¨(mach_ vm_ map)ç”³è¯·å†…å­˜ï¼Œç”³è¯·åçš„Zoneå¯¹è±¡æŒ‡é’ˆå­˜æ”¾åœ¨zoneæŒ‡é’ˆæ•°ç»„ä¸­ã€‚nano_zone å’Œ scalable_zone éƒ½ä¼šåœ¨å¯åŠ¨åæ‡’åŠ è½½åˆå§‹åŒ–1ä¸ªã€‚</p>

<p>å½“æ‰§è¡Œmalloc æ—¶ï¼Œä¼šè°ƒç”¨ malloc_zone_malloc(default_zone, size) ã€‚å…¶ä¸­default_zone æ˜¯ä¸€ä¸ªé™æ€çš„zone,æ˜¯ä¸€ä¸ª virtual_default_zone ç»“æ„ã€‚å…¶å†…éƒ¨å­˜æ”¾äº†default_zone æ‰€éœ€è¦çš„å‡½æ•°æŒ‡é’ˆã€‚å¦‚default_zone_size,default_zone_malloc ç­‰ã€‚è€Œdefault_zone æœ¬è´¨ä¸Šä¸ä¼šå‚ä¸å‡½æ•°åˆ†é…ï¼Œè€Œæ˜¯å¯»æ‰¾malloc_zones ä¸­çš„ç¬¬0ä¸ªzone æ¥åˆ†é…å†…å­˜ã€‚(default_zone å­˜åœ¨çš„æ„ä¹‰åº”è¯¥æ˜¯å¯¹å¤–æä¾›æ¥å£ï¼Œæ–¹ä¾¿å¼€å‘è€…å†™è‡ªå·±çš„default_zone, ç›‘å¬å†…å­˜ç”³è¯·é‡Šæ”¾æµç¨‹)ã€‚ä¸‹é¢æ˜¯ default_zone_malloc å‡½æ•°çš„å®ç°</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>static void *
default_zone_malloc(malloc_zone_t *zone, size_t size)
{
        zone = runtime_default_zone();

        return zone-&gt;malloc(zone, size);
}
</code></pre></div></div>

<p>libmalloc çš„å¤–å±‚å¤§è‡´ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œé™æ€æŒ‡é’ˆmalloc_zones ç®¡ç†ç€nano_zone å’Œ scalable_zoneã€‚å¤–éƒ¨é€šè¿‡default_zone è°ƒç”¨çœŸå®çš„zone æ¥åˆ†é…å†…å­˜ã€‚æ­¤å¤–ä¹Ÿå¯ä»¥çœ‹åˆ°scalable_zone  ä¸­æ‰€ç®¡ç†çš„3ä¸ªrackã€‚å†…å­˜åˆ†é…çš„æ ¸å¿ƒæ“ä½œåœ¨scalable_zone å’Œ nano_zoneä¸­</p>

<p><img src="https://s2.loli.net/2022/01/02/bghnet5PTiUYF34.png" alt="Minion" /></p>

<p>å†…å­˜åœ¨nano_zone å’Œ scalable_zoneä¸­çš„åˆ†é…æµç¨‹è¿˜ä¸å¤ªä¸€æ ·ï¼Œå…¶ä¸­scalable_zoneæ¯”è¾ƒå¤æ‚ä¸€ç‚¹ã€‚åç»­çš„ä¾‹å­éƒ½ä»¥scalable_zoneä¸ºä¾‹ã€‚</p>

<p>ä¸‹é¢è¿™æ®µä»£ç æ˜¯zoneæ ¹æ®sizeèµ°ä¸åŒçš„rackè¿›è¡Œåˆ†é…çš„æµç¨‹</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MALLOC_NOINLINE void *
szone_malloc_should_clear(
    szone_t *szone, 
    size_t size, 
    boolean_t cleared_requested)
{
        void *ptr; // è¿”å›ç»™ä¸Šå±‚çš„æŒ‡é’ˆ
        msize_t msize; //sizeè½¬æ¢æˆéœ€è¦çš„blockæ•°ç›®

        if (size &lt;= SMALL_THRESHOLD) {
                // tiny size: &lt;=1008 bytes (64-bit), &lt;=496 bytes (32-bit)
                // think tiny
                msize = TINY_MSIZE_FOR_BYTES(size + TINY_QUANTUM - 1);
                if (!msize) {
                        msize = 1;
                }
                ptr = tiny_malloc_should_clear(&amp;szone-&gt;tiny_rack, msize, cleared_requested);
        } else if (size &lt;= szone-&gt;large_threshold) {
                // small size: &lt;=15k (iOS), &lt;=64k (large iOS), &lt;=128k (macOS)
                // think small
                msize = SMALL_MSIZE_FOR_BYTES(size + SMALL_QUANTUM - 1);
                if (!msize) {
                        msize = 1;
                }
                ptr = small_malloc_should_clear(&amp;szone-&gt;small_rack, msize, cleared_requested);
        } else {
                // large: all other allocations
                size_t num_kernel_pages = round_page_quanta(size) &gt;&gt; vm_page_quanta_shift;
                if (num_kernel_pages == 0) { /* Overflowed */
                        ptr = 0;
                } else {
                        ptr = large_malloc(szone, num_kernel_pages, 0, cleared_requested);
                }
        }

        //å†…å­˜æ¶‚é¸¦
        if ((szone-&gt;debug_flags &amp; MALLOC_DO_SCRIBBLE) &amp;&amp; ptr &amp;&amp; !cleared_requested &amp;&amp; size) {
                memset(ptr, SCRIBBLE_BYTE, szone_size(szone, ptr));
        }

        return ptr;
}

</code></pre></div></div>

<p>rack å’Œ magazineçš„å…³ç³»å¦‚ä¸‹å›¾ã€‚æ¯ä¸ªrackä¸­æŒæœ‰ä¸€ä¸ªé•¿åº¦ä¸ºé€»è¾‘CPUæ•°çš„magazineæ•°ç»„ï¼ˆlibmalloc-166.200.60 ä¸­æ²¡æœ‰medium_rackï¼‰
<img src="https://s2.loli.net/2022/01/02/OiXJInhQyuKredZ.png" alt="" /></p>

<p>rack ä¸­çš„å˜é‡magazines æ˜¯ magazineçš„æ•°ç»„ã€‚æ•°ç»„å¤§å°ç”±logic CPUæ•°æ¥å†³å®šã€‚å®é™…magazines çš„count = logical_cpu_num + 1ã€‚å…¶ä¸­å¤šå‡ºæ¥çš„ä¸€ä¸ªæ˜¯depot_magazineã€‚å½“1ä¸ªmagazineçš„å†…å­˜ä¸å¤Ÿåˆ†é…æ—¶ï¼Œä¼šå»depot_magazine ä¸­è¯·æ±‚å†…å­˜ã€‚æ•°ç»„ä¸­æ¯ä¸ªmagazineéƒ½ä¼šæœ‰ä¸€æŠŠè‡ªå·±çš„é”ï¼Œè¿™æ ·åšå¯ä»¥é™ä½é”çš„èŒƒå›´ï¼Œåœ¨çº¿ç¨‹å±‚é¢åšåˆ°å¹¶å‘ï¼Œæé«˜å†…å­˜ç”³è¯·é€Ÿåº¦ã€‚
æ¥çœ‹ä¸‹rackç»“æ„çš„å£°æ˜</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//æ¥çœ‹ä¸‹rackç»“æ„çš„å£°æ˜
typedef struct rack_s {
        /* Regions for tiny objects */
        _malloc_lock_s region_lock MALLOC_CACHE_ALIGN;

        rack_type_t type; //ç±»å‹
        size_t num_regions; //æœ‰å¤šå°‘ä¸ªregion
        size_t num_regions_dealloc;
        region_hash_generation_t *region_generation;
        region_hash_generation_t rg[2];
        region_t initial_regions[INITIAL_NUM_REGIONS];

        int num_magazines; //magazineçš„ä¸ªæ•°
        unsigned num_magazines_mask; //è®¡ç®—åº”è¯¥ç”¨å“ªä¸ªmagazineçš„è¾…åŠ©å˜é‡
        int num_magazines_mask_shift;
        uint32_t debug_flags;

        // array of per-processor magazines
        magazine_t *magazines; //magazine æ•°ç»„

        uintptr_t cookie;
        uintptr_t last_madvise;
} rack_t;

</code></pre></div></div>

<p>magazine æ˜¯çœŸæ­£æ“ä½œå†…å­˜çš„å¯¹è±¡ã€‚æ¥çœ‹ä¸€ä¸‹å…¶ä¸­å‡ ä¸ªé‡è¦çš„å±æ€§</p>
<ol>
  <li><strong>mag_last_free</strong> ä¸Šæ¬¡é‡Šæ”¾çš„åœ°å€/ mag_last_free_msize:ä¸Šæ¬¡é‡Šæ”¾çš„size/mag_last_free_rgn:ä¸Šæ¬¡é‡Šæ”¾çš„region ã€‚è¿™ä¸‰ä¸ªå±æ€§çš„ä½œç”¨æ˜¯å½¢æˆä¸€ä¸ªcacheã€‚å½“æœ¬æ¬¡ç”³è¯·çš„sizeå’Œä¸Šæ¬¡é‡Šæ”¾çš„sizeä¸€è‡´çš„æ—¶å€™ï¼Œç›´æ¥è¿”å›ä¸Šæ¬¡é‡Šæ”¾çš„åœ°å€ã€‚ç›®çš„æ˜¯ä¸ºäº†æé«˜é€Ÿåº¦</li>
  <li><strong>mag_bitmap</strong> magazine ä¸­çš„è¿™ä¸ªbitmapæ˜¯ç®¡ç†ç©ºé—²é“¾è¡¨çš„ã€‚å¦‚æœä¸€ä¸ªç©ºé—²é“¾è¡¨ä¸­æ²¡æœ‰ç»“ç‚¹ï¼Œmag_bitmap ä¸­å¯¹åº”çš„bitä¼šè¢«è®¾ç½®ä¸º0ã€‚è¯·æ³¨æ„ä¸è¦å’Œheap regionä¸­çš„bitmap ææ··ã€‚</li>
  <li><strong>mag_free_lists</strong> ç©ºé—²é“¾è¡¨æ•°ç»„ã€‚æ•°ç»„ä¸­çš„å…ƒç´ ï¼Œæ˜¯ç©ºé—²é“¾è¡¨ã€‚æ‰€ä»¥è¿™æ˜¯ä¸€ä¸ªæ•°ç»„å¥—é“¾è¡¨çš„ç»“æ„ã€‚è€Œç¬¬1ä¸ªç©ºé—²é“¾è¡¨çš„æ¯ä¸ªèŠ‚ç‚¹å†…å­˜å¤§å°ä¸º1ä¸ªblockï¼ˆ16byteï¼‰ï¼Œç¬¬2ä¸ªç©ºé—²é“¾è¡¨çš„æ¯ä¸ªèŠ‚ç‚¹å¤§å°ä¸º2ä¸ªblockï¼ˆ32byteï¼‰ï¼Œç¬¬3ä¸ªç©ºé—²é“¾è¡¨çš„æ¯ä¸ªèŠ‚ç‚¹å¤§å°ä¸º3ä¸ªblockï¼ˆ48byteï¼‰ï¼Œç”±äºTinyæœ€å¤šä¸€æ¬¡åˆ†é…1008byteï¼Œæ‰€ä»¥æœ€åä¸€ä¸ªç©ºé—²é“¾è¡¨çš„æ¯ä¸ªèŠ‚ç‚¹å¤§å°ä¸º63ä¸ªblockã€‚ ä½†æ˜¯ï¼Œæœ€å1ä¸ªï¼Œä¹Ÿå°±æ˜¯ç¬¬64ä¸ªç©ºé—²é“¾è¡¨çš„æ¯ä¸ªèŠ‚ç‚¹å¤§å°æ˜¯å¤§äº64ä¸ªblockï¼Œè¿™æ˜¯ç”±äºè¯¥é“¾è¡¨çš„èŠ‚ç‚¹æ˜¯freeçš„æ—¶å€™åˆå¹¶äº§ç”Ÿçš„ã€‚</li>
  <li><strong>recirculation_entries/firstNode/lastNode</strong> è¿™ä¸‰ä¸ªæŒ‡é’ˆç®¡ç†äº†ä¸€ä¸ªåŒå‘é“¾è¡¨ã€‚åŒé“¾è¡¨ä¸­çš„èŠ‚ç‚¹æ˜¯heap regionã€‚</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//magazineçš„å£°æ˜
typedef struct magazine_s { 
        // Take magazine_lock first, Depot lock when needed for recirc, then szone-&gt;{tiny,small}_regions_lock when needed for alloc
        _malloc_lock_s magazine_lock MALLOC_CACHE_ALIGN;
        // å½“å‰æ˜¯å¦åœ¨å‘å†…æ ¸ç”³è¯·heap region
        volatile boolean_t alloc_underway;

        //ä¸Šä¸€æ¬¡é‡Šæ”¾çš„åœ°å€
        void *mag_last_free;
        //ä¸Šä¸€æ¬¡é‡Šæ”¾çš„å¤§å°
        msize_t mag_last_free_msize;
#if MALLOC_TARGET_64BIT
        uint32_t _pad;
#endif
        // ä¸Šä¸€æ¬¡é‡Šæ”¾çš„Region
        region_t mag_last_free_rgn;

        //ç©ºé—²é“¾è¡¨
        free_lists_t mag_free_lists[magazine_free_lists_SLOTS];
        //ç©ºé—²ä½å›¾
        uint32_t mag_bitmap[magazine_free_lists_BITMAP_WORDS];

        // the first and last free region in the last block are treated as big blocks in use that are not accounted for
        size_t mag_bytes_free_at_end;
        size_t mag_bytes_free_at_start;
        // æœ€åä¸€æ¬¡å‘å†…æ ¸ç”³è¯·çš„heap regionåœ°å€
        region_t mag_last_region; 
        
        
        size_t mag_num_bytes_in_objects; // å·²ç»åˆ†é…å‡ºå»çš„å†…å­˜çš„å¤§å°
        size_t num_bytes_in_magazine; // magazine ä¸­æ€»å…±æœ‰å¤šå°‘å¤§å°
        unsigned mag_num_objects; //region æ•°é‡

        //å¾ªç¯é“¾è¡¨å’Œé¦–ä½èŠ‚ç‚¹
        unsigned recirculation_entries;
        region_trailer_t *firstNode;
        region_trailer_t *lastNode;

#if MALLOC_TARGET_64BIT
        uintptr_t pad[320 - 14 - magazine_free_lists_SLOTS -
                        (magazine_free_lists_BITMAP_WORDS + 1) / 2];
#else
        uintptr_t pad[320 - 16 - magazine_free_lists_SLOTS -
                        magazine_free_lists_BITMAP_WORDS];
#endif

} magazine_t;

</code></pre></div></div>

<p>tiny_regin çš„ç»“æ„å£°æ˜å¦‚ä¸‹é¢çš„ä»£ç </p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// tiny_regin çš„ç»“æ„
typedef struct tiny_region {
        // region æ‰€æŒæœ‰çš„å…¨éƒ¨block
        tiny_block_t blocks[NUM_TINY_BLOCKS];
        // è¿½è¸ªå™¨ï¼Œç®¡ç†å†…éƒ¨çš„blocks
        region_trailer_t trailer;
        // æ ‡è®°headeræ˜¯å¦è¢«ä½¿ç”¨çš„æ•°æ®ç»“æ„ï¼Œæ˜¯header å’Œ used ç»„æˆçš„
        tiny_header_used_pair_t pairs[CEIL_NUM_TINY_BLOCKS_WORDS];

        uint8_t pad[TINY_REGION_SIZE - (NUM_TINY_BLOCKS * sizeof(tiny_block_t)) - TINY_METADATA_SIZE];
} * tiny_region_t;
</code></pre></div></div>

<p>heap region æ˜¯è°ƒç”¨å†…æ ¸ mach_vm_map åˆ†é…çš„ï¼Œæ˜¯ç”¨æˆ·å¯ä»¥å®é™…æ“ä½œçš„å†…å­˜ã€‚ä»¥1ä¸ªTiny regionæ¥ä¸¾ä¾‹å­çœ‹ã€‚Region å¯ä»¥åˆ†ä¸º data å’Œ meta dataä¸¤ä¸ªåŒºã€‚ è“è‰²çš„åŒºåŸŸè¡¨ç¤ºè¢«åˆ†é…å‡ºå»çš„blockæˆ–è€…æ˜¯åˆšåˆšé‡Šæ”¾çš„blockï¼Œç»¿è‰²çš„dataåŒºå¯ä»¥ä½œä¸ºblockåˆ†é…å‡ºå»ï¼Œä¹Ÿå¯ä»¥ä½œä¸ºç©ºé—²é“¾è¡¨çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå­˜æ”¾ä¸¤ä¸ªæŒ‡é’ˆã€‚ meta data ä¸­ä¸»è¦å­˜æ”¾äº†å°†regionä¸²åœ¨ä¸€èµ·çš„pre/next æŒ‡é’ˆï¼Œä»¥åŠbitmapã€‚å…¶ä¸­bitmapä¸­åˆåŒ…å«äº†2ä¸ªå­bitmapã€‚
<img src="https://s2.loli.net/2022/01/02/d7mozIOW2KtpPgy.png" alt="" /></p>

<p>heap regionå’Œmagazineçš„å…³ç³»</p>
<ul>
  <li>heap regions ä¼šç”¨è‡ªèº«çš„ä¸¤ä¸ªpre/nextæŒ‡é’ˆå°†è‡ªå·±å’Œå…¶ä»–çš„heap regionä¸²èµ·æ¥æˆä¸ºä¸€ä¸ªåŒå‘é“¾è¡¨</li>
  <li>magazineçš„first_nodeå’Œlast_nodeæŒ‡å‘heap region metaDataåŒå‘é“¾è¡¨çš„ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªèŠ‚ç‚¹</li>
  <li>magazineçš„mag_last_regionæŒ‡å‘æœ€åä¸€æ¬¡magazineå‘å†…æ ¸ç”³è¯·çš„heap region
<img src="https://s2.loli.net/2022/01/02/5CnjHZ9qDPFeRT1.png" alt="" /></li>
</ul>

<p>è¿™é‡Œæˆ‘ä»¬ç¨å¾®åœç•™ä¸€ä¸‹ï¼Œçœ‹çœ‹regionä¸­çš„bitmapå’Œmagazineä¸­çš„ç©ºé—²é“¾è¡¨æ˜¯æ€ä¹ˆå·¥ä½œçš„
é¦–å…ˆï¼Œbitmapæ˜¯ä¸¤ä¸ªå­bitç»„æˆçš„ï¼Œåˆ†åˆ«å¯ä»¥æˆä¸ºheader bitmap å’Œ used bitmapï¼Œå®ƒä»¬ä¸­é—´ç”¨0xFFFFFFFFæ¥éš”å¼€ã€‚æ¯ä¸ªblockåœ¨å­bitmapä¸­å ä¸€ä¸ªbitï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨bitmapä¸­ä¸€ä¸ªblockå 2ä¸ªbitã€‚header bitmap ç”¨æ¥æ ‡è®°ä¸€å—å†…å­˜åŒºåŸŸçš„èµ·ç‚¹ï¼Œå¦‚æœæ˜¯1ï¼Œè¡¨ç¤ºæ˜¯ä¸€ä¸ªèµ·ç‚¹ï¼ˆheadï¼‰ï¼Œused bitmap ç”¨æ¥æ ‡è®°ä¸€ä¸ªåŒºåŸŸæ˜¯å¦æ˜¯åœ¨ä½¿ç”¨ä¸­ï¼Œ1è¡¨ç¤ºä½¿ç”¨ä¸­ï¼Œ0è¡¨ç¤ºç©ºé—²
bitmapä½¿ç”¨ä¸‹é¢3æ¡è§„åˆ™:</p>
<ul>
  <li>å¦‚æœä¸€å—åŒºåŸŸå·²ç»è¢«ä½¿ç”¨ï¼Œé‚£ä¹ˆè¿™å—åŒºåŸŸçš„ç¬¬ä¸€ä¸ªblockåœ¨header bitmap å’Œ used bitmapä¸­å¯¹åº”çš„å€¼éƒ½æ˜¯1.</li>
  <li>å¦‚æœä¸€å—åŒºåŸŸæ˜¯ç©ºé—²çš„ï¼Œé‚£ä¹ˆè¿™å—åŒºåŸŸçš„ç¬¬ä¸€ä¸ª block åœ¨ header bitmap å’Œ used bitmapä¸­å¯¹åº”çš„å€¼åˆ†åˆ«æ˜¯1å’Œ0.</li>
  <li>å…¶ä»–æƒ…å†µä¸‹ï¼Œquantumåœ¨ header bitmapä¸­çš„å€¼æ˜¯0.</li>
</ul>

<p>header bitmap ç”¨æ¥æ ‡è®°ä¸€ä¸ªå—çš„èµ·å§‹ä½ç½®ï¼Œå¦‚æœä¸º1ï¼Œå°±æ˜¯ä¸€ä¸ªå—çš„èµ·å§‹ã€‚é‚£ä¹ˆå¦‚ä½•åˆ¤æ–­è¿™ä¸ªblockæ˜¯å·²ç»åˆ†é…è¿˜æ˜¯ç©ºé—²çš„å‘¢ï¼Ÿåœ¨used bit map ä¸­ä¸º1çš„å°±æ˜¯1ä¸ªå·²åˆ†é…å—çš„èµ·å§‹ã€‚å¦‚æœheader bitmap ä¸º1 ï¼Œused bitmap ä¸º0ï¼Œé‚£å°±æ˜¯ä¸€ä¸ªç©ºé—²blockçš„èµ·å§‹ã€‚å…¶å®å¾ˆç®€å•ï¼Œheaderæ ‡è®°ä¸€ä¸ªå—çš„èµ·å§‹ï¼Œused è®°å½•ä½¿ç”¨çŠ¶æ€
<img src="https://s2.loli.net/2022/01/02/B2pEZkL73HYxs9d.png" alt="" /></p>

<p>é‚£ä¹ˆæˆ‘ä»¬ä»¥ä¸Šå›¾ä¸ºä¾‹ï¼Œé˜è¿°ä¸‹ç©ºé—²åŒº1æ˜¯æ€ä¹ˆè¢«å®šä½çš„:</p>
<ol>
  <li>ä»å·¦å¾€å³æ‰«æï¼Œå‘ç°q0åœ¨ä¸¤ä¸ªbitmapä¸­çš„å€¼éƒ½æ˜¯1ï¼Œé‚£ä¹ˆè¡¨æ˜q0æ˜¯ä¸€å—å·²ä½¿ç”¨åŒºåŸŸçš„å¼€å§‹ã€‚</li>
  <li>ç»§ç»­æ‰«æï¼Œå‘ç°q2åˆ°qi-1åœ¨header bitmapä¸­çš„å€¼éƒ½æ˜¯0ï¼Œè¯´æ˜è¿™æ˜¯å·²ä½¿ç”¨åŒºåŸŸçš„ä¸€éƒ¨åˆ†ã€‚</li>
  <li>æ‰«æåˆ°qiï¼Œå‘ç°qiåœ¨header bitmapä¸­æ˜¯1ï¼Œin use bitmapä¸­æ˜¯0ï¼Œè¯´æ˜è¿™æ˜¯ç©ºé—²å—çš„èµ·å§‹</li>
  <li>ç»§ç»­æ‰«å¾€ä¸‹æ‰«æå°±å¥½äº†â€¦</li>
</ol>

<h5 id="free_lists">free_lists</h5>
<p>free_listsæ˜¯magazine çš„ç©ºé—²é“¾è¡¨æ•°ç»„ã€‚é‡Šæ”¾è¿‡çš„å†…å­˜ä¼šä½œä¸ºèŠ‚ç‚¹å­˜å‚¨åœ¨ç©ºé—²é“¾è¡¨ä¸­ã€‚æ•°ç»„å…ƒç´ ç©ºé—²é“¾è¡¨æŒ‰ç…§å†…å­˜å—å¤§å°é€’å¢ã€‚å…¶ä¸­ï¼Œç¬¬1ä¸ªç©ºé—²é“¾è¡¨ï¼Œæ¯ä¸ªèŠ‚ç‚¹çš„å¤§å°æ˜¯1ä¸ªblockï¼ˆ16byteï¼‰ï¼›ç¬¬2ä¸ªç©ºé—²é“¾è¡¨æ¯ä¸ªèŠ‚ç‚¹çš„å¤§å°æ˜¯2ä¸ªblockï¼ˆ32byteï¼‰ï¼›ç¬¬3ä¸ªç©ºé—²é“¾è¡¨çš„å¤§å°ä¸ºï¼ˆ48byteï¼‰ï¼›ä¾æ¬¡ç±»æ¨ä¸‹å»ã€‚</p>

<p>å¯¹äºtiny_rackæœ€å¤šåˆ†é…1008ä¸ªå­—èŠ‚ï¼Œå› æ­¤è¯¥rackä¸‹çš„æ¯ä¸ªmagazineçš„ç©ºé—²é“¾è¡¨æ•°ç»„ä¸ªæ•°æœ€å¤§ä¸º1008/16 + 1 = 63ï¼Œç¬¬63ä¸ªç©ºé—²é“¾è¡¨çš„æ¯ä¸ªèŠ‚ç‚¹å†…å­˜ä¸º63blocks(=1008B)ã€‚ä½†æ˜¯ç©ºé—²é“¾è¡¨çš„å®é™…ä¸ªæ•°ä¸º63+1 = 64 ä¸ªã€‚æœ€åä¸€ä¸ªç¬¬64ä¸ªç©ºé—²é“¾è¡¨çš„æ¯ä¸ªèŠ‚ç‚¹å†…å­˜å¤§äºç­‰äº64blocks(&gt;=1024Bï¼‰è¯¥é“¾è¡¨çš„èŠ‚ç‚¹æ˜¯freeçš„æ—¶å€™åˆå¹¶äº§ç”Ÿçš„ã€‚
ç©ºé—²é“¾è¡¨èŠ‚ç‚¹çš„ç»“æ„éå¸¸ç®€å•ï¼Œåªæœ‰pre,next ä¸¤ä¸ªæŒ‡é’ˆã€‚æ‰€ä»¥å¯¹äº16byteçš„ç©ºé—²é“¾è¡¨èŠ‚ç‚¹ï¼Œå…¶ä¸­åªèƒ½å­˜æ”¾preï¼Œnextä¸¤ä¸ªæŒ‡é’ˆã€‚
å¯¹äºå¤§äº16byteå°äºç­‰äº1008byteçš„ç©ºé—²é“¾è¡¨çš„èŠ‚ç‚¹ã€‚å‰é¢16byteå­˜æ”¾pre/nextæŒ‡é’ˆï¼ŒæŒ‡é’ˆåçš„ä¸¤ä¸ªå­—èŠ‚å­˜æ”¾å—å¤§å°ã€‚å‰©ä½™ç©ºé—´å°±æ˜¯åˆ†é…å‡ºå»ä¾›ä½¿ç”¨çš„å†…å­˜äº†ã€‚
<img src="https://s2.loli.net/2022/01/02/B2pEZkL73HYxs9d.png" alt="" /></p>

<h2 id="æ€»ç»“ä¸€ä¸‹">æ€»ç»“ä¸€ä¸‹</h2>
<ul>
  <li><big>åœ¨iOS/MacOS ä¸Šï¼Œå†…å­˜ç®¡ç†ä½¿ç”¨äº†å”¯ä¸€çš„åº“libmallocã€‚æ‰€æœ‰çš„å†…å­˜ç”³è¯·å’Œé‡Šæ”¾éƒ½ä¼šé€šè¿‡libmalloc è¿›è¡Œã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯æ–¹ä¾¿å†…å­˜ç®¡ç†ï¼Œä¹Ÿæ–¹ä¾¿ä¸€äº›å†…å­˜åˆ†æå·¥å…·çš„å¼€å‘å»ºè®¾</big></li>
  <li><big>å¼€å‘è€…å¯ä»¥é€šè¿‡æ¥å—libmallocçš„å›è°ƒå‡½æ•°æ¥äº†è§£å†…å­˜çš„ä½¿ç”¨æƒ…å†µã€‚Instrumentä¸­å¾ˆå¤šè°ƒè¯•å·¥å…·ä¹Ÿæ˜¯é€šè¿‡è¿™ä¸ªåŸç†å¼€å‘çš„</big></li>
  <li><big>libmalloc çš„ç»“æ„:zoneï¼Œrackï¼Œmagazineï¼Œheap region</big></li>
  <li><big>libmalloc ç®¡ç†å†…å­˜çš„ä¸»è¦æ–¹å¼æ˜¯ç©ºé—²é“¾è¡¨å’Œbitmapï¼Œå…¶ä¸­bitmapæ˜¯ç”±headerå’Œused ä¸¤ä¸ªå­mapç»„æˆ</big></li>
</ul>

<h2 id="çŸ¥è¯†æ¥æºå‚è€ƒ">çŸ¥è¯†æ¥æºå‚è€ƒ</h2>
<p><a href="https://tannerjin.github.io/2019/12/16/iOS%E5%86%85%E5%AD%98-%E5%A0%86-libmalloc-magazine-zone/">tannerjin çš„ blog</a><br />
<a href="https://luchengzhong.github.io/gitblog/2018/06/12/iOS-%E5%86%85%E6%A0%B8-%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-3-%E8%AF%A6%E8%A7%A3iOS%E6%98%AF%E6%80%8E%E4%B9%88malloc%E7%9A%84-%E4%B8%8A.html">luchenzong çš„blog</a></p>
:ET